{{- if .Values.whisperLive.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "vexa.componentName" (list . "whisperlive") }}
  labels:
    {{- include "vexa.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.whisperLive.replicaCount }}
  selector:
    matchLabels:
      {{- include "vexa.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: whisperlive
  template:
    metadata:
      labels:
        {{- include "vexa.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: whisperlive
      annotations:
        {{- toYaml .Values.global.podAnnotations | nindent 8 }}
    spec:
      securityContext:
        {{- toYaml .Values.global.podSecurityContext | nindent 8 }}
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: whisperlive
          securityContext:
            {{- toYaml .Values.global.securityContext | nindent 12 }}
          image: "{{ .Values.whisperLive.image.repository }}:{{ .Values.whisperLive.image.tag }}"
          imagePullPolicy: {{ .Values.global.imagePullPolicy }}
          {{- if .Values.whisperLive.args }}
          args:
            {{- toYaml .Values.whisperLive.args | nindent 12 }}
          {{- else }}
          args:
            - "--port"
            - {{ .Values.whisperLive.service.wsPort | quote }}
            - "--faster_whisper_custom_model_path"
            - {{ .Values.whisperLive.model.size | quote }}
          {{- end }}
          ports:
            - name: ws
              containerPort: 9090
            - name: health
              containerPort: 9091
          env:
            - name: REDIS_STREAM_URL
              value: {{ printf "%s/%s" (include "vexa.redisUrl" .) .Values.transcriptionCollector.config.redisStreamName | quote }}
            - name: REDIS_URL
              value: {{ include "vexa.redisUrl" . | quote }}
            - name: REDIS_HOST
              value: {{ include "vexa.redisHost" . | quote }}
            - name: REDIS_PORT
              value: {{ include "vexa.redisPort" . | quote }}
            - name: REDIS_STREAM_KEY
              value: {{ .Values.transcriptionCollector.config.redisStreamName | quote }}
            - name: REDIS_SPEAKER_EVENTS_RELATIVE_STREAM_KEY
              value: {{ .Values.transcriptionCollector.config.redisSpeakerEventsStreamName | quote }}
            - name: WL_MAX_CLIENTS
              value: {{ .Values.whisperLive.tuning.wlMaxClients | quote }}
            - name: CONSUL_ENABLE
              value: {{ .Values.whisperLive.tuning.consulEnable | quote }}
            - name: WL_LISTEN_PORT
              value: {{ .Values.whisperLive.service.wsPort | quote }}
            - name: WL_PING_INTERVAL_S
              value: {{ .Values.whisperLive.tuning.pingIntervalSeconds | quote }}
            - name: WL_PING_TIMEOUT_S
              value: {{ .Values.whisperLive.tuning.pingTimeoutSeconds | quote }}
            - name: DEVICE_TYPE
              value: {{ .Values.whisperLive.profile | quote }}
            - name: WHISPER_MODEL_SIZE
              value: {{ .Values.whisperLive.model.size | quote }}
            - name: LANGUAGE_DETECTION_SEGMENTS
              value: {{ .Values.whisperLive.tuning.languageDetectionSegments | quote }}
            - name: VAD_FILTER_THRESHOLD
              value: {{ .Values.whisperLive.tuning.vadFilterThreshold | quote }}
            {{- with .Values.whisperLive.remoteTranscriber.url }}
            - name: REMOTE_TRANSCRIBER_URL
              value: {{ . | quote }}
            {{- end }}
            {{- if .Values.whisperLive.remoteTranscriber.apiKey }}
            - name: REMOTE_TRANSCRIBER_API_KEY
              value: {{ .Values.whisperLive.remoteTranscriber.apiKey | quote }}
            {{- else if .Values.secrets.existingSecretName }}
            - name: REMOTE_TRANSCRIBER_API_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.secrets.existingSecretName | quote }}
                  key: TRANSCRIBER_API_KEY
            {{- end }}
            {{- with .Values.whisperLive.remoteTranscriber.model }}
            - name: REMOTE_TRANSCRIBER_MODEL
              value: {{ . | quote }}
            {{- end }}
            {{- with .Values.whisperLive.remoteTranscriber.temperature }}
            - name: REMOTE_TRANSCRIBER_TEMPERATURE
              value: {{ . | quote }}
            {{- end }}
            {{- with .Values.whisperLive.remoteTranscriber.vadModel }}
            - name: REMOTE_TRANSCRIBER_VAD_MODEL
              value: {{ . | quote }}
            {{- end }}
            {{- with .Values.whisperLive.extraEnv }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          readinessProbe:
            httpGet:
              path: /health
              port: health
            initialDelaySeconds: 20
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: health
            initialDelaySeconds: 60
            periodSeconds: 20
          volumeMounts:
            - name: hf-cache
              mountPath: /root/.cache/huggingface/hub
            - name: models
              mountPath: /app/models
          resources:
            {{- if eq .Values.whisperLive.profile "gpu" }}
            {{- toYaml .Values.whisperLive.resourcesGpu | nindent 12 }}
            {{- else }}
            {{- toYaml .Values.whisperLive.resourcesCpu | nindent 12 }}
            {{- end }}
      volumes:
        - name: models
          emptyDir: {}
        {{- if .Values.whisperLive.cache.enabled }}
        - name: hf-cache
          persistentVolumeClaim:
            claimName: {{ include "vexa.componentName" (list . "whisperlive-cache") }}
        {{- else }}
        - name: hf-cache
          emptyDir: {}
        {{- end }}
      {{- with .Values.whisperLive.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- else }}
      {{- with .Values.global.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- end }}
      {{- with .Values.whisperLive.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- else }}
      {{- with .Values.global.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- end }}
      {{- with .Values.whisperLive.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- else }}
      {{- with .Values.global.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- end }}
{{- end }}
